<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=0">
    <title>Andy's 贪吃蛇</title>
	<style>
		.switch {
		  position: relative;
		  display: inline-block;
		  width: 60px;
		  height: 34px;
		}
		/* Hide default HTML checkbox */
		.switch input {
		  opacity: 0;
		  width: 0;
		  height: 0;
		}
		/* The slider */
		.slider {
		  position: absolute;
		  cursor: pointer;
		  top: 0;
		  left: 0;
		  right: 0;
		  bottom: 0;
		  background-color: #ccc;
		  -webkit-transition: .4s;
		  transition: .4s;
		}
		.slider:before {
		  position: absolute;
		  content: "";
		  height: 26px;
		  width: 26px;
		  left: 4px;
		  bottom: 4px;
		  background-color: white;
		  -webkit-transition: .4s;
		  transition: .4s;
		}
		input:checked + .slider {
		  background-color: #2196F3;
		}
		input:focus + .slider {
		  box-shadow: 0 0 1px #2196F3;
		}
		input:checked + .slider:before {
		  -webkit-transform: translateX(26px);
		  -ms-transform: translateX(26px);
		  transform: translateX(26px);
		}
		/* Rounded sliders */
		.slider.round {
		  border-radius: 34px;
		}
		.slider.round:before {
		  border-radius: 50%;
		}
		
		.dark-theme {
			background-color: gray;
		}
		.hidden {
			visibility: hidden;
		}
	</style>
</head>
<body style="text-align: center;">
	<img id="suprise" src="https://media.tenor.com/images/f9b6ff59de7341b51eab1b6c7c250e91/tenor.gif" style="position: absolute; height: 180px; left: 20px; top: 20px;" class="hidden">
	<h1 style="margin:60px auto 20px"><span id="score">0</span></h1>
	<div style="margin-bottom:60px">
		<img name="star" class="hidden" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAOdSURBVEhLjVbLTlRBEG02mhBN+AT9A2LY6b/oxu/Qn9CwMCGEJXs1MMMwMDOJJg5RV+pCNPLQAEPUyILuvp5TVd333h5HvSHNqe6qU6eruhtcjNF7jzHIV5j4ajNWsapgEs6OysAp0oDmAr5WQFXFi8/+134AmM3bNKm6mCpMAtAdrfgNFzddPF6hKauFW9MENtVq6Kgge3hYqMO2iwMXhy4AwAwlEYCOmcRU65QuNwNogujgERmHzoN924WDx1KW2dUT8I82QjC336fkIKr9rgs7DtSQMR2VAca6jTJf8EqVj1ch2Q/mKqqeAzuE+8NV7KZ2K6LENNU6O+XBaoThtbCreskbRHgcXUdW8foDrwKnvzCKB7wrbJb7hV6AozXfk+4Jr1CL/J4Lx2tsgzjzJ536nCa1UYg4+st43vcHy/HD/TBeDFsQmOqQhJvZc/7VLbp9WQ7n/RguTU1KQNWcOtsIowX0J245D7q+9ErrIESoQwBopkFX0Vt44vBgEx0X0eHRgj/dUPmglmMLOhANJJLxPA+5b8abRgGWFUv0x25GnKQ47AZaY4WCSB3kRlijKIeg4G3oVZMhBCkKbaAJlUrNuqBAkx2PSyws4mR9I04C1SSgQNHb5FU3kEx22NVWGycdLBRENHN922kEcNXcYKLcZ5vKa21UJOy92DU/BiRdKLqVRdqQeCW9pGQxybsFEmOTNhpiBvTztKvsJqSWr6ChV1ZVgfJmvXb4MsKs1f3kWZBrknQxPpsZkFdN9O3kecELbG8IUL2Ayry+7XGMZL+J18zMi5EzcHtzZ5oXwNqYF4hQlvGiNk15UzWksuDVU6EJUOW9RYQUvABGraMA3tQ4nMdVNKLM20iTgeSb56VLb2xO0G4jFgJPe0jnBLw8HpCmr5LUt1UWuOFtoCTWBJ+yYbQ26iynkP/7GK9Sjs96cx1oymG3NGjjj73/aCM8Dp/geSJv8zGRxwEnh31LWSXxHJ0PnxTlxle2kft6d9fjL5bqxbOAanQdzkzAPwsXnwhwirmUtoXH7/09KXdLpTyqMoWRczweS3I85DijMi9uxJ9vuV/owipGmC9vMp+w8+0dL3G+rbJuI0YCeOw/5GOCWzO46s863IfUscq6NM2k63evoEqx4/zHB3STjyTi1rqNtoCwk6fx6zoB6PK8xwTj1V9X47d1D+cpXoymGmOewgREMdLMOoDRLVPaPsWrZquNGcwgKs2/ucX4Gzwqs9pVjT84AAAAAElFTkSuQmCC">
		<span id="starSpan" ></span>
	</div>
	<div style="display:none;">
		<img id="snakeHead" src='https://uc18a643fbe046f3d4029173bf7c.dl.dropboxusercontent.com/cd/0/inline/CCoeU7jJmQ4MkgT8NLNiHGXitKyoQ-9D3jfKqZp1lu4SOmoGmPnmXzn2c-4fQBliuBuLAhQ2Rn1bnJVc4zzum-8mAHGExWf_zrk2PPcWpSpSCqqFoGAPPV3Pd6N6Jo82HMUuVGqdjsZosGjrKOeBXI5H/file#'/>
		<img id="snakeHead_openMouth" src='https://uc28c0e7705ad0c4bf04fc52f82b.dl.dropboxusercontent.com/cd/0/inline/CCoeYPVwNwotBX61w-mB-VtKMeIZTqqdrKEjFzb7cPfR4VyQw4tzfxyg2MEZUGsHVNvsBij2TdvHBmksFZE3VXdzfmdZgL7O-T97rkSP9PyI8bkFVt9Hj7LBuZzaPCU_Ec6dvS1mgvLTXr32EywXVOCk/file#'/>
	</div>
	<canvas id="can" width="800px" height="800px" style="border: 8px double chocolate; margin-bottom: 20px;">对不起，您的浏览器不支持canvas</canvas>
	<!-- Rounded switch -->
	<div style="line-height: 35px; width: 800px; margin: auto;">
		<label class="switch">
			<input type="checkbox" value=false onChange="toggleTheme(this)">
			<span class="slider round"/>  
		</label>
		<span style="font-size: 20px">Andy's 深色主题</span>
		<div style="background-color: #25ae88; width: 200px; margin: 30px auto; color: white; line-height: 80px; font-size: 24px;" onClick="reset();">重新开始</div>
		<h3 style="text-align: left;">操作说明：</h3>
		<div style="text-align: left; font-size: 20px">移动设备：使用手势，上下左右滑动来控制贪吃蛇前进的方向。每次变相操作完成，手指需离开屏幕</div>
		<div style="text-align: left; font-size: 20px">键盘设备：使用上、下、左、右箭头操作</div>
	</div>
	
    <script>
		const cellsInOneRow = 20, cellSizeInPixes = 40;
		var score = 0;
		var touchStartPosition;
		var isDarkTheme = false, backgroundColor = "white";
		var timeOut;
		
		const canvas = document.getElementById('can');
        var snake = [41, 40],       // snake队列表示蛇身，初始节点存在但不显示
            direction = 1,          // 1表示向右，-1表示向左，20表示向下，-20表示向上
            food = 43,              // 食物的位置
            n,                      // 下一个要到的位置的序号，范围[0,399]
            box = canvas.getContext('2d'); // 从0到399表示box里[0~19]*[0~19]的所有节点，每20px一个节点
		drawBackground();
		
		var scoreElement = document.getElementById('score');
		var starSpanElement = document.getElementById('starSpan');
		var hiddenStar = document.getElementsByName('star')[0];
		
		var gifs = [
		'https://media.giphy.com/media/vQqeT3AYg8S5O/giphy.gif',
		'https://media4.giphy.com/media/l0EwYB32fj4VZxMpa/giphy.gif',
		'https://media.giphy.com/media/XweOsBl72PFcc/giphy.gif',
		'https://media.giphy.com/media/lJ0JGfNBrRWJVCRChd/giphy.gif',
		'https://i2.wp.com/media4.giphy.com/media/5p2wQFyu8GsFO/giphy.gif',
		'https://media.giphy.com/media/jIRPOnUASNsQw/giphy.gif',
		'https://media.giphy.com/media/XR9Dp54ZC4dji/giphy.gif',
		'https://media.giphy.com/media/1Zt3z4uEBPZQY/giphy.gif',
		'https://media.giphy.com/media/tPx9tL0kRmUDe/giphy.gif',
		'https://media.giphy.com/media/liFaAWEOa1uKc/giphy.gif',
		'https://media.giphy.com/media/2gtoSIzdrSMFO/giphy.gif'];
		var gifImg = document.getElementById('suprise');
		const snakeHeadImg = document.getElementById("snakeHead");
		const snakeHeadImgOpen = document.getElementById("snakeHead_openMouth");
		
        function drawHead(seat, openMouth) {
			
			const topLeftX = seat % cellsInOneRow * cellSizeInPixes + 1, topLeftY = ~~(seat / cellsInOneRow) * cellSizeInPixes + 1, cellSize = cellSizeInPixes-2;
			const translateX = topLeftX + cellSize/2, translateY = topLeftY + cellSize/2;
			var img = openMouth? snakeHeadImgOpen: snakeHeadImg;
			box.save();
			box.translate(translateX, translateY);
			var rotation = 0;
			if(openMouth) scale = 1.1;
			if(direction == 20) {
				rotation = Math.PI / 2;
			} else if(direction == -20) {
				rotation = -Math.PI / 2;
			} else if(direction == - 1 ) {
				rotation = Math.PI;
				box.scale(1, -1);
			}
			
			box.rotate(rotation);
			box.drawImage(img, 0-cellSize/2, 0-cellSize/2, cellSize, cellSize);
			box.translate(-translateX, -translateY);
			box.restore();
        }

		function draw(seat, fillColor, radius) {
			//用color填充一个矩形，以前两个参数为x，y坐标，后两个参数为宽和高。
            box.fillStyle = fillColor;
			let borderRadius = [];
			borderRadius.push(radius);
			box.beginPath();
            box.roundRect(seat % cellsInOneRow * cellSizeInPixes + 1, ~~(seat / cellsInOneRow) * cellSizeInPixes + 1, cellSizeInPixes-2, cellSizeInPixes-2, borderRadius);
			box.fill();
        }

        document.onkeydown = function(evt) {    
            //当键盘上下左右键摁下的时候改变direction
            direction = snake[1] - snake[0] == (n = [-1, 0-cellsInOneRow, 1, cellsInOneRow][(evt || event).keyCode - 37] || direction) ? direction : n;
        };
		document.addEventListener('touchstart',function (event) {
			var touch = event.targetTouches[0];
			touchStartPosition = {
				x: touch.pageX,
				y: touch.pageY
			};
		});
		document.body.addEventListener('touchmove', (e) => {
			e.preventDefault();
		}, { passive: false });
		document.addEventListener('touchend',function (event) {
			var touch = event.changedTouches[0];
			var movedX = touch.pageX -touchStartPosition.x;
			var movedY = touch.pageY -touchStartPosition.y;
			var isScrolling = Math.abs(movedX) < Math.abs(movedY) ? 1:0; //isScrolling为1时，表示纵向滑动，0为横向滑动
			if(isScrolling) {
				event.preventDefault();
				if(movedY > 20) {
					direction = direction == -20? direction : 20; // go down
				} else if (movedY < -20) {
					direction = direction == 20? direction : -20; // go up
				}
			} else {
				if(movedX > 20) {
					direction = direction == -1? direction: 1; // go right
				} else if(movedX < -20) {
					direction = direction == 1? direction : -1; // go left
				}
			}
		});
		run();
		
        function run() {
            snake.unshift(n = snake[0] + direction); //此时的n为下次蛇头出现的位置，n进入队列
            if(snake.indexOf(n, 1) > 0 || n < 0 || n > 399 || direction == 1 && n % cellsInOneRow == 0 || direction == -1 && n % cellsInOneRow == (cellsInOneRow-1)) {
                //if语句判断贪吃蛇是否撞到自己或者墙壁，碰到时返回，结束程序
				scoreElement.innerHTML = "GAME OVER!";
                return  ;
            }
            drawHead(n, n + direction == food);    // 画出蛇头下次出现的位置
			draw(snake[1], "lime", 10); // redraw the cell used to be the snake head
            if(n == food) {         //如果吃到食物时，产生一个蛇身以外的随机的点，不会去掉蛇尾
				if(score > 0 && score % 10 == 0) {
					var newStar = hiddenStar.cloneNode(true);
					newStar.classList.remove('hidden');
					starSpanElement.appendChild(newStar);
					
					var gifIndex = (score/10 - 1) > 11? 11: (score/10 - 1);
					gifImg.classList.remove('hidden');
					setTimeout(function(){
						gifImg.classList.add('hidden') ;
						console.log(score);
						console.log(gifIndex);
						gifImg.src = gifs[gifIndex];
					}, 3000)
				}
				scoreElement.innerHTML = "得分:" + score++;
                while (snake.indexOf(food = ~~(Math.random() * 400)) > 0);
                draw(food, "yellow", 0);
            } else {                //没有吃到食物时正常移动，蛇尾出队列
                draw(snake.pop(), backgroundColor);
            }
            timeOut = setTimeout(arguments.callee, 250); //每隔0.25秒执行函数一次，可以调节蛇的速度
        };
		
		function reset() {
			starSpanElement.innerHTML = "";
			box.clearRect(0, 0, canvas.width, canvas.height);
			drawBackground();
			score = 0;
			snake = [41, 40],       // snake队列表示蛇身，初始节点存在但不显示
            direction = 1,          // 1表示向右，-1表示向左，20表示向下，-20表示向上
            food = 43,              // 食物的位置
			clearTimeout(timeOut);
			run();
		}
		
		function drawBackground() {
			box.beginPath();
			box.strokeStyle = "#CCC";
			for(var i =1; i < 20; i++) {
				box.moveTo(0, cellSizeInPixes * i);
				box.lineTo(800, cellSizeInPixes * i);
				box.moveTo(cellSizeInPixes * i, 0);
				box.lineTo(cellSizeInPixes * i, 800);	
			}
			box.stroke();
		}
		
		function toggleTheme(element) {
			isDarkTheme = !isDarkTheme;
			if(isDarkTheme) {
				backgroundColor = "gray";
				canvas.classList.add('dark-theme');
			} else {
				backgroundColor = "white";
				canvas.classList.remove('dark-theme');
			}
			for(var i = 0; i<399; i++) {
				if(snake.indexOf(i) < 0 && i!=food) {
					draw(i, backgroundColor);
				}
			}
		}
     </script>
</body>
